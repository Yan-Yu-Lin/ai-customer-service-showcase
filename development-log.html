<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 客服系統開發日誌</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">AI 客服系統專案</h1>
            <ul class="nav-links">
                <li><a href="index.html">系統架構</a></li>
                <li><a href="development-log.html" class="active">開發日誌</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <header class="page-header">
            <h1>AI 客服系統開發日誌</h1>
            <p class="subtitle">專案開發進度與技術決策記錄</p>
        </header>

        <!-- Phase 1 -->
        <article class="log-entry">
            <header class="log-header">
                <h2>第一階段：專案初始化</h2>
                <time class="log-date">2025-06-12</time>
            </header>

            <section class="log-content">
                <h3>完成項目</h3>
                
                <div class="completion-section">
                    <h4>1. 專案架構建立</h4>
                    <ul>
                        <li>建立三個獨立的專案資料夾：
                            <ul>
                                <li><code>backend/</code> - API 伺服器</li>
                                <li><code>admin-dashboard/</code> - 管理介面</li>
                                <li><code>chat-widget/</code> - 聊天小工具</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="completion-section">
                    <h4>2. 後端設定 (backend/)</h4>
                    <p><strong>技術選擇：</strong>Node.js + Express + TypeScript</p>
                    <p><strong>安裝的套件：</strong></p>
                    <ul>
                        <li>基礎：express, cors, dotenv</li>
                        <li>認證：jsonwebtoken, bcrypt</li>
                        <li>資料庫：pg (PostgreSQL)</li>
                        <li>檔案處理：multer, pdf-parse, mammoth</li>
                        <li>AI：@anthropic-ai/sdk</li>
                    </ul>
                    <p><strong>專案結構：</strong></p>
                    <div class="code-block">
                        <pre><code>src/
├── routes/      # API 路由
├── services/    # 業務邏輯
├── models/      # 資料模型
├── middleware/  # 中介軟體
└── utils/       # 工具函數</code></pre>
                    </div>
                    <p><strong>資料庫設計：</strong></p>
                    <ul>
                        <li>建立完整的 PostgreSQL schema</li>
                        <li>包含 users、documents、conversations 等表格</li>
                        <li>支援全文搜尋功能</li>
                        <li>提供測試用種子資料</li>
                    </ul>
                </div>

                <div class="completion-section">
                    <h4>3. 管理介面設定 (admin-dashboard/)</h4>
                    <ul>
                        <li><strong>技術選擇：</strong>Vue 3 + TypeScript + Vite</li>
                        <li><strong>UI 框架：</strong>Element Plus</li>
                        <li><strong>狀態管理：</strong>Pinia</li>
                        <li><strong>路由：</strong>Vue Router 4</li>
                        <li><strong>開發 Port：</strong>8080</li>
                    </ul>
                </div>

                <div class="completion-section">
                    <h4>4. 聊天小工具設定 (chat-widget/)</h4>
                    <ul>
                        <li><strong>技術選擇：</strong>Vue 3 + TypeScript + Vite</li>
                        <li><strong>建構方式：</strong>配置為 library 模式，產出單一 JS 檔案</li>
                        <li><strong>開發 Port：</strong>8081</li>
                    </ul>
                </div>

                <h3>技術決策記錄</h3>
                <div class="decision-grid">
                    <div class="decision-card">
                        <h4>為什麼選擇 TypeScript</h4>
                        <ul>
                            <li>提供類型安全，減少執行時錯誤</li>
                            <li>更好的 IDE 支援和程式碼提示</li>
                            <li>適合團隊協作</li>
                        </ul>
                    </div>

                    <div class="decision-card">
                        <h4>為什麼選擇 PostgreSQL</h4>
                        <ul>
                            <li>支援 JSON 資料類型（適合儲存對話記錄）</li>
                            <li>內建全文搜尋功能</li>
                            <li>成熟穩定，效能優異</li>
                        </ul>
                    </div>

                    <div class="decision-card">
                        <h4>為什麼選擇 Element Plus</h4>
                        <ul>
                            <li>完整的企業級 UI 元件</li>
                            <li>良好的 Vue 3 支援</li>
                            <li>中文文檔友善</li>
                        </ul>
                    </div>
                </div>

                <h3>遇到的問題與解決方案</h3>
                <div class="problem-solution">
                    <div class="problem">
                        <h4>路徑問題</h4>
                        <p><strong>問題：</strong>使用相對路徑導致 cd 命令失敗</p>
                        <p><strong>解決：</strong>改用絕對路徑，並正確處理空格</p>
                    </div>

                    <div class="problem">
                        <h4>Git 配置</h4>
                        <p><strong>問題：</strong>CLAUDE.md 檔案衝突</p>
                        <p><strong>解決：</strong>移除了 CLAUDE.md 檔案，配置了適當的 .gitignore</p>
                    </div>
                </div>

                <div class="git-info">
                    <h3>Git Commit</h3>
                    <ul>
                        <li><strong>Commit ID:</strong> <code>b5ce227</code></li>
                        <li><strong>Message:</strong> feat: 初始化 AI 客服系統專案架構</li>
                        <li><strong>變更：</strong> 46 個檔案變更，7431 行新增</li>
                    </ul>
                </div>

                <div class="checklist">
                    <h3>測試檢查清單</h3>
                    <ul>
                        <li>後端伺服器可以啟動 (npm run dev)</li>
                        <li>管理介面可以啟動 (npm run dev)</li>
                        <li>聊天小工具可以啟動 (npm run dev)</li>
                        <li>資料庫 schema 可以執行</li>
                        <li>環境變數配置正確</li>
                    </ul>
                </div>
            </section>
        </article>

        <!-- Phase 2 -->
        <article class="log-entry">
            <header class="log-header">
                <h2>第二階段：基本聊天功能原型</h2>
                <time class="log-date">2025-06-12</time>
            </header>

            <section class="log-content">
                <div class="strategy-change">
                    <h3>開發策略調整</h3>
                    <ul>
                        <li><strong>原計劃：</strong>先完成認證系統和文檔管理</li>
                        <li><strong>調整後：</strong>優先實作聊天功能，讓使用者能快速測試</li>
                        <li><strong>原因：</strong>提供立即可見的成果，提升開發體驗</li>
                    </ul>
                </div>

                <h3>完成項目</h3>

                <div class="completion-section">
                    <h4>1. 後端聊天 API (<code>backend/src/routes/chat.ts</code>)</h4>
                    <div class="api-feature">
                        <h5>聊天訊息端點：<code>POST /api/chat/message</code></h5>
                        <ul>
                            <li>接收訊息並返回模擬回應</li>
                            <li>使用暫時的 API key 驗證</li>
                            <li>預留 Anthropic API 整合位置（TODO 註解）</li>
                        </ul>
                    </div>
                    <div class="api-feature">
                        <h5>對話歷史端點：<code>GET /api/chat/conversations/:id</code></h5>
                        <ul>
                            <li>目前返回空陣列</li>
                            <li>為未來功能預留介面</li>
                        </ul>
                    </div>
                </div>

                <div class="completion-section">
                    <h4>2. 聊天小工具 UI (<code>chat-widget/src/components/ChatWidget.vue</code>)</h4>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <h5>介面設計</h5>
                            <ul>
                                <li>浮動聊天按鈕（右下角）</li>
                                <li>可展開/收合的聊天視窗</li>
                                <li>iOS 風格的簡潔設計</li>
                            </ul>
                        </div>
                        <div class="feature-item">
                            <h5>功能實作</h5>
                            <ul>
                                <li>即時訊息發送和顯示</li>
                                <li>訪客/助理訊息區分</li>
                                <li>打字動畫效果</li>
                                <li>本地儲存對話資訊</li>
                            </ul>
                        </div>
                        <div class="feature-item">
                            <h5>響應式設計</h5>
                            <ul>
                                <li>桌面版：固定寬度 350px</li>
                                <li>手機版：全螢幕顯示</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h3>技術問題與解決</h3>
                <div class="problem-solution">
                    <div class="problem">
                        <h4>TypeScript 類型錯誤</h4>
                        <p><strong>問題：</strong>Express 中介軟體類型不匹配</p>
                        <p><strong>解決：</strong>調整函數返回類型，使用 Promise&lt;any&gt;</p>
                    </div>

                    <div class="problem">
                        <h4>缺少類型定義</h4>
                        <p><strong>問題：</strong>pg 模組缺少 TypeScript 類型</p>
                        <p><strong>解決：</strong>安裝 @types/pg</p>
                    </div>
                </div>

                <h3>測試結果</h3>
                <div class="test-results">
                    <h4>API 測試</h4>
                    <div class="code-block">
                        <pre><code># 健康檢查
curl http://localhost:3000/health
# 結果：{"status":"ok","timestamp":"2025-06-12T12:01:49.161Z","environment":"development"}

# 聊天 API
curl -X POST http://localhost:3000/api/chat/message \
  -H "Content-Type: application/json" \
  -H "x-api-key: test_api_key_development" \
  -d '{"message": "你好，這是測試"}'
# 結果：成功返回模擬回應</code></pre>
                    </div>

                    <h4>服務狀態</h4>
                    <ul class="status-list">
                        <li class="status-ok">後端：Port 3000 ✅</li>
                        <li class="status-ok">聊天小工具：Port 8081 ✅</li>
                        <li class="status-warning">資料庫：連接失敗（預期行為）⚠️</li>
                    </ul>
                </div>

                <div class="git-info">
                    <h3>Git Commit</h3>
                    <ul>
                        <li><strong>Commit ID:</strong> <code>59bde57</code></li>
                        <li><strong>Message:</strong> feat: 實作基本聊天功能原型 - 快速開發路徑</li>
                    </ul>
                </div>
            </section>
        </article>

        <!-- Phase 3 -->
        <article class="log-entry">
            <header class="log-header">
                <h2>第三階段：Anthropic API 整合</h2>
                <time class="log-date">2025-06-12</time>
            </header>

            <section class="log-content">
                <h3>完成項目</h3>

                <div class="completion-section">
                    <h4>1. AI 服務模組（<code>backend/src/services/ai.ts</code>）</h4>
                    <div class="service-features">
                        <h5>建立完整的 AI 服務類別</h5>
                        <ul>
                            <li>封裝 Anthropic SDK 操作</li>
                            <li>支援普通聊天和串流聊天</li>
                            <li>實作 prompt 工程</li>
                            <li>完整的錯誤處理機制</li>
                        </ul>
                        
                        <h5>主要功能</h5>
                        <ul>
                            <li><code>sendMessage()</code>: 一次性完整回應</li>
                            <li><code>sendMessageStream()</code>: 即時串流回應</li>
                            <li><code>estimateTokens()</code>: Token 數量估算</li>
                            <li>自動重試和超時處理</li>
                        </ul>
                    </div>
                </div>

                <div class="completion-section">
                    <h4>2. 更新聊天路由</h4>
                    <div class="api-updates">
                        <div class="api-update">
                            <h5>普通聊天端點：<code>POST /api/chat/message</code></h5>
                            <ul>
                                <li>整合 AI 服務</li>
                                <li>返回完整回應和 token 使用資訊</li>
                                <li>支援對話 ID 和訪客 ID</li>
                            </ul>
                        </div>
                        <div class="api-update">
                            <h5>串流聊天端點：<code>POST /api/chat/message/stream</code></h5>
                            <ul>
                                <li>使用 Server-Sent Events (SSE)</li>
                                <li>即時傳送文字片段</li>
                                <li>適合長回應和更好的用戶體驗</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h3>技術細節</h3>
                <div class="tech-details">
                    <h4>使用的技術</h4>
                    <ul>
                        <li>Anthropic TypeScript SDK (<code>@anthropic-ai/sdk</code>)</li>
                        <li>Claude 3.5 Sonnet 模型（最新版）</li>
                        <li>Server-Sent Events 用於串流</li>
                    </ul>

                    <h4>錯誤處理</h4>
                    <ol>
                        <li>API key 驗證</li>
                        <li>速率限制處理（429 錯誤）</li>
                        <li>網路錯誤自動重試</li>
                        <li>友善的錯誤訊息</li>
                    </ol>

                    <h4>成本控制措施</h4>
                    <ul>
                        <li>Max tokens 限制為 1024</li>
                        <li>Token 使用追蹤</li>
                        <li>建議實作快取機制</li>
                    </ul>
                </div>

                <h3>使用方式</h3>
                <div class="usage-guide">
                    <div class="step">
                        <h4>1. 設定 API Key：</h4>
                        <div class="code-block">
                            <pre><code># 在 backend/.env 檔案中
ANTHROPIC_API_KEY=your-api-key-here</code></pre>
                        </div>
                    </div>

                    <div class="step">
                        <h4>2. 測試 API：</h4>
                        <div class="code-block">
                            <pre><code>cd backend
node test-api.js</code></pre>
                        </div>
                    </div>

                    <div class="step">
                        <h4>3. 在聊天小工具中測試：</h4>
                        <ul>
                            <li>訪問 http://localhost:8081</li>
                            <li>輸入問題測試 AI 回應</li>
                        </ul>
                    </div>
                </div>

                <h3>已知限制</h3>
                <div class="limitations">
                    <div class="limitation">
                        <h4>尚未實作對話歷史</h4>
                        <ul>
                            <li>每次對話都是獨立的</li>
                            <li>需要資料庫支援</li>
                        </ul>
                    </div>

                    <div class="limitation">
                        <h4>沒有文檔搜尋</h4>
                        <ul>
                            <li>AI 只能根據 prompt 回答</li>
                            <li>無法參考上傳的文檔</li>
                        </ul>
                    </div>

                    <div class="limitation">
                        <h4>基本的 prompt</h4>
                        <ul>
                            <li>可以根據業務需求優化</li>
                            <li>加入更多公司特定資訊</li>
                        </ul>
                    </div>
                </div>
            </section>
        </article>

        <!-- Phase 4 -->
        <article class="log-entry">
            <header class="log-header">
                <h2>第四階段：修復關鍵問題</h2>
                <time class="log-date">2025-06-12</time>
            </header>

            <section class="log-content">
                <h3>修復的問題</h3>

                <div class="fix-section">
                    <h4>1. ConversationId 格式不匹配</h4>
                    <ul>
                        <li><strong>問題：</strong>前端生成 <code>conv-timestamp</code> 格式，後端驗證要求 UUID</li>
                        <li><strong>症狀：</strong>第二則訊息會失敗（400 Bad Request）</li>
                        <li><strong>解決：</strong>將驗證從 <code>.isUUID()</code> 改為 <code>.isString()</code></li>
                        <li><strong>影響檔案：</strong><code>backend/src/routes/chat.ts</code></li>
                    </ul>
                </div>

                <div class="fix-section">
                    <h4>2. 對話無記憶</h4>
                    <ul>
                        <li><strong>問題：</strong>每則訊息都是獨立的，AI 無法記住之前的對話</li>
                        <li><strong>原因：</strong>conversationHistory 永遠是空的</li>
                        <li><strong>解決：</strong>實作 in-memory 對話儲存</li>
                    </ul>
                    <div class="code-block">
                        <pre><code>const conversationStore = new Map&lt;string, Array&lt;{ role, content }&gt;&gt;();</code></pre>
                    </div>
                    <p><strong>限制：</strong></p>
                    <ul>
                        <li>重啟後端會遺失所有對話</li>
                        <li>最多保留 20 則訊息（10 輪對話）</li>
                        <li>不同視窗間無法共享</li>
                    </ul>
                </div>

                <div class="fix-section">
                    <h4>3. CORS 動態埠號問題</h4>
                    <ul>
                        <li><strong>問題：</strong>Widget 可能在 8081 或 8082，但 CORS 只允許固定埠號</li>
                        <li><strong>解決：</strong>開發環境允許所有 <code>http://localhost:*</code></li>
                        <li><strong>影響檔案：</strong><code>backend/src/index.ts</code></li>
                    </ul>
                </div>

                <h3>技術決策</h3>
                <div class="decision-grid">
                    <div class="decision-card">
                        <h4>為什麼用 Map 而非資料庫？</h4>
                        <ul>
                            <li>快速開發，立即見效</li>
                            <li>避免 PostgreSQL 設定複雜度</li>
                            <li>適合開發測試階段</li>
                        </ul>
                    </div>

                    <div class="decision-card">
                        <h4>為什麼限制 20 則訊息？</h4>
                        <ul>
                            <li>防止記憶體無限增長</li>
                            <li>Claude API token 限制</li>
                            <li>保持對話相關性</li>
                        </ul>
                    </div>
                </div>

                <h3>測試確認</h3>
                <ul class="test-checklist">
                    <li class="test-pass">✅ 多則訊息連續發送正常</li>
                    <li class="test-pass">✅ AI 能記住之前的對話內容</li>
                    <li class="test-pass">✅ 不同埠號的 Widget 都能連接</li>
                    <li class="test-pass">✅ 錯誤訊息更詳細易懂</li>
                </ul>

                <h3>下一步優化建議</h3>
                <div class="next-steps">
                    <div class="step-card">
                        <h4>持久化對話</h4>
                        <ul>
                            <li>整合 PostgreSQL</li>
                            <li>實作對話 CRUD API</li>
                            <li>支援對話歷史查詢</li>
                        </ul>
                    </div>

                    <div class="step-card">
                        <h4>改善 ConversationId</h4>
                        <ul>
                            <li>使用真正的 UUID（安裝 uuid 套件）</li>
                            <li>統一前後端格式</li>
                            <li>支援對話恢復</li>
                        </ul>
                    </div>

                    <div class="step-card">
                        <h4>優化記憶體管理</h4>
                        <ul>
                            <li>實作 LRU 快取</li>
                            <li>定期清理過期對話</li>
                            <li>監控記憶體使用</li>
                        </ul>
                    </div>
                </div>

                <div class="git-info">
                    <h3>Git Commit</h3>
                    <ul>
                        <li><strong>Commit ID:</strong> <code>379fbbc</code></li>
                        <li><strong>Message:</strong> feat: 完成 Anthropic API 整合並修復關鍵問題</li>
                    </ul>
                </div>
            </section>
        </article>

        <div class="environment-info">
            <h2>開發環境資訊</h2>
            <ul>
                <li>Node.js 版本：18+</li>
                <li>npm 版本：10.8.0</li>
                <li>PostgreSQL 版本：14+（尚未安裝）</li>
                <li>開發機器：macOS Darwin 24.5.0</li>
                <li>Anthropic SDK：@anthropic-ai/sdk 最新版</li>
            </ul>
        </div>
    </main>

    <footer class="footer">
        <p>AI 客服系統專案 &copy; 2025 - 康和證券合作專案</p>
    </footer>

    <script src="js/main.js"></script>
</body>
</html>